[appendix]
= Annex A: Abstract Test Suite (Normative)

CAUTION: link:https://github.com/opengeospatial/WFS_FES/issues/46[ISSUE 46] +
OpenAPI Validation

== A.1: Requirements Trace Matrix
----
Requirement 1: API Definition
Description:
include::requirements/requirement_api-definition.adoc[]
Tests: A.1.n
----
----
Requirement 2: Conformance Report
Description:
include::requirements/requirement_fc-md-op.adoc[]
Tests: A.1.n
----
----
Requirement 3: OpenAPI Definition
Description:
include::requirements/requirement_oas-definition.adoc[]
Tests: A.1.n
----
----
Requirement 4: OpenAPI Implementation
include::requirements/requirement_oas-impl.adoc[]
Tests: A.1.n
----
----
Requirement 5: WFS 3.0 Core
include::requirements/requirements_class_core.adoc[]
Tests: A.1.n
----
----
Requirement 6: GeoJSON Extension
include::requirements/requirements_class_geojson.adoc[]
Tests: A.1.n
----
----
Requirement 7: GML Simple Features Level 0 Extension
include::requirements/requirements_class_gmlsf0.adoc[]
Tests: A.1.n
----
----
Requirement 8: GML Simple Features Level 2 Extension
include::requirements/requirements_class_gmlsf2.adoc[]
Tests: A.1.n
----
----
Requirement 9: HTML Extension
include::requirements/requirements_class_html.adoc[]
Tests: A.1.n
----
----
Requirement 10: OpenAPI 3.0
Description:
include::requirements/requirements_class_oas30.adoc[]
Tests: A.1.n
----

<TODO - find a better place for this>
Conventions:
URL templates are used throughout these test suites.  The terms used to describe portions of these templates are based on the URL syntax described in RFC 3986.
. scheme: http | https
. authority: DNS name of the server with optional port number
. path: The slash delimited identifier for a resource on the server
. query: query parameters following the "?" character
. fragment: identifies an element within the resource. Preceded by the "\#" character

=== A.2: OpenAPI 3.0 Test Suites*
The following test suites shall be used if the service description is provided using OpenAPI 3.0.
----
A.2.1 API Definition
 a) Test Purpose: Validate that the serivce provides an API definition page on the required path
 b) Pre-conditions: Client is aware of the root path to the service
 c) Test Method:
     1) Client issues a get request on {scheme}://{authority}/api
         i) Accept header is set to ?????
     2) Client receives an API defnintion document in response to the get request
     3) Client validates that the API defnintion document complies with OpenAPI [red]#should reference the OpenAPI test#
 d) References: Requirement R1
 e) Notes: 
    1) This operation is usually where the client and server initially authenticate their identities to each other.  Intermediate challenges and responses in support of authentication do not invalidate the results of this test.
    2) A server may have an open and protected API definition.  In that case, two get requests may be required; one to retrieve the open definition, and the second executed after authentication to retrieve the protected definition.  Subsequent testing should be performed using the protected definition whenever security policy allows.
----
----
A.2.2 Conformance Report
 a) Test Purpose: Validate that the service provides a conformance report on the required path 
 b) Pre-conditions: Client is aware of the root path to the service
 c) Test Method:
     1) Client issues a get request on {scheme}://{authority}/api/conformance
         i) Accept header is set to ?????
     2) Client receives an API Conformance Report document in response to the get request
     3) Client validates the Conformance Report document through test A.2.2.1
 d) References: 
     Requirements: R2, R3 
     Tests: A.2.2.1
----
----
A.2.2.1 Conformance Report Validation
 a) Test Purpose: Validate that the Conformance Report complies with the mandated format
 b) Pre-conditions: A Conformance Report has been received
 c) Test Method:
     1) Validate the Conformance Report against the schema defined in req-classes.yaml 
 d) References: 
     Requirements: R3
----
----
A.2.3 HTTP 1.1
 a) Test Purpose: Validate that the service supports and conforms to HTTP 1.1
 b) Pre-conditions: Client is aware of the root path to the service
 c) Test Method: TBD - it is unknown if a conformance test for HTTP 1.1 exists.
 d) References: 
     Requirements: R4
----
----
A.2.4 Feature Collection Metadata
 a) Test Purpose: Validate that the service provides valid Feature Collection metadata on the mandated path
 b) Pre-conditions: Client is aware of the root path to the service
 c) Test Method:
     1) Client issues a get request on {scheme}://{authority}/
         i) Accept header is set to ?????
     2) Client receives an Feature Collection Metadata document in response to the get request
     3) Client validates the Feature Collection Metadata document schema through test A.2.4.1
     4) Client Validates the contents of the Feature Collection Metadata document through test A.2.4.2
 d) References: 
     Requirements: R5
     Tests: A.2.4.1, A.2.4.2
----
----
A.2.4.1 Feature Collection Metadata Schema Validation
 a) Test Purpose: Validate that the Feature Collection Metadata complies with the mandated format
 b) Pre-conditions: A Feature Collection Metadata document has been received
 c) Test Method:
     1) Validate the Feature Collection Metadata document against the schema defined in content.yaml
 d) References: 
     Requirements: R6
----
----
A.2.4.2 Feature Collection Metadata Content Validation
 a) Test Purpose: Validate that the Feature Collection Metadata content is correct and complete
 b) Pre-conditions: A Feature Collection Metadata document has been received
 c) Test Method:
     1) Validate the links property of the Feature Collection Metadata through test A.2.4.2.1
     2) Validate the collections property of the Feature Collection Metadata through test A.2.4.2.2 (r8)
 d) References: 
     Tests: A.2.4.2.1, A.2.4.2.2
----
----
A.2.4.2.1 Feature Collection Metadata Links Property Validation
 a) Test Purpose: Validate that the LInkes property of the Feature Collection Metadata content is correct and complete
 b) Pre-conditions: A Feature Collection Metadata document has been received
 c) Test Method:
     1) Validate the links property includes a valid link to the Feature Collection Metadata document on the server
     2) Validate the links property includes valid links to Feature Collection Metadata documents in every media type offered by the server
     3) For each Feature Collection and each media type offered by the server, validate that the links property includes a valid link to that resource.
     4) Validate the links property includes valid links to API Definition documents in every media type offered by the server
 d) References: 
     Requirements: R7
----
----
A.2.4.2.2 Feature Collection Metadata Collections Property Validation
 a) Test Purpose: Validate that the Collections property of the Feature Collection Metadata content is correct and complete
 b) Pre-conditions: A Feature Collection Metadata document has been received
 c) Test Method:
     1) Validate that there is a collections property for every Feature Collection hosted on the server. (issue: where does this info come from?)
     2) Validate that each Collections property includes a links property
     3) For each Collections property; validate that the links property includes entries for each encoding supported by the server. (Issue: how do we know the encodings supported?)
     4) For each links property of each Collections property; validate that each entry in the links property resolves to the proper Feature Collection and encoding. (Validate by matching Feature names)
     5) Validate that each collections propery includes a valid extent property
     6) For each Feature Collection, validate that all Features contained in that collection fall within the bounding box defined by the extent property.
 d) References: 
     Requirements: R8, R9, R10
----
----
A.2.5 Feature Collections
 a) Test Purpose: Validate that the service provides Feature Collections on the mandated paths
 b) Pre-conditions: Client possesses Feature Collection metadata which provides paths to each Feature Collection
 c) Test Method: 
     For each Feature Collection identified in the Feature Collection metadata
     1) Client issues a get request on {scheme}://{authority}/{collectionId}
         i) Accept header is set to ?????
     2) Client receives an Feature Collection in response to the get request
     3) Client validates the expected Features were returned given the default values of the query parameters.
     4) Client re-issues the get request with non-default values for the query parameters.
     5) Client validates the expected Features were returned given the non-default values of the query parameters.
     6) Client validates the content of the returned feature set using test A.2.5.1
 d) References: 
     Requirements: R11, R12, R13, R14, R15, R16, 
     Tests: A.2.5.1
 e) Notes:
    Query parameters are:
    1) count: the maximum number of Features returned at one time (R12 & R13).
    2) bbox: only Features which fall within or intersect the boundaries of this box should be returned (R14 & R15)  
----
----
A.2.5.1 Feature Result Set
 a) Test Purpose: Validate that the returned Features are complete and correct.
 b) Pre-conditions: A Feature Collection has been received
 c) Test Method:
     For each Feature in the Feature Collection
     1) Client validates that the links property is present
     2) Client validates that the links property includes an entry for each media type supported by the service.
     3) Client validates that each entry in the links property includes the rel and type parameters
     4) Client validates that all of the entries in the links property resolve to representations of the Feature in the appropriate media type.
 d) References: 
     Requirements: R16, R17, R18
----
----
A.2.6 Features
 a) Test Purpose: Validate that individual Features can be retrieved
 b) Pre-conditions: A Feature Collection has been received
 c) Test Method:
    For each Feature in the Feature Collection:
    1) Client issues a get request on {scheme}://{authority}/{collectionId}/{id}
         i) Accept header is set to ?????
    2) Client validates that a Feature document is returned.
    3) Client validates that the name property of the Feature matches the {id} 
    4) Client validates the Feature using test A.2.6.1
 d) References: 
     Requirements: R19, R20
     Tests: A.2.6.1
----
----
A.2.6.1 Feature Validation
 a) Test Purpose: Validate the contents of a Feature
 b) Pre-conditions: A Feature has been retrieved
 c) Test Method:
     1) Client validates that the links property is present
     2) Client validates that each entry in the links property includes the rel and type parameters
     3) For every media type supported by the server:
         i) Client validates that there is a link entry for the Feature (self) 
         ii) Client validates that the entry resolves to representations of the Feature in the appropriate media type.
     4) Client validates that the links property includes an entry for the Feature Collection.
 d) References: 
     Requirements: R20, R21
----
----
A.2.7 HTML Extension
 a) Test Purpose: Validate that HTML encoding is supported property
 b) Pre-conditions: 
    1) A request has been issued with the Accepts header set to "text/html"
    2) A "200" response has been received with the Content-Type header set to "text/html"
 c) Test Method:
    1) Client validates that HTML is one of the advertised media types supported by the server.
    2) Client validates that the received payload includes <needs clarification in the spec>
 d) References: 
     Requirements: R22, R23
----
----
A.2.8 GeoJSON Extension
 a) Test Purpose: Validate that the GeoJSON extension is supported property
 b) Pre-conditions: Client has determined that the server supports GeoJSON
 c) Test Method:
     1) Validate handling of Features and Feature Collections using test A.2.8.1
     2) Validate handling of all other "200" responses using test A.2.8.2 
 d) References: 
     Requirements: R24, R25
     Tests: A.2.8.1, A.2.8.2
----
----
A.2.8.1 GeoJSON Response Validation
 a) Test Purpose: Validate that GeoJSON responses are supported property
 b) Pre-conditions: A Feature or Feature Collection response has been received
 c) Test Method:
     1) Validate that the request had the accepts header set to "application/geo+json"
     2) Validate that the content-type header of the response is set to "application/geo+json"
     3) Validate that the response complies with the GeoJSON standard.
 d) References: 
     Requirements: R24, R25
----
----
A.2.8.2 JSON Response Validation
 a) Test Purpose: Validate that JSON responses are supported property
 b) Pre-conditions: A response has been received which is not a Feature or Feature Collection
 c) Test Method:
     1) Validate that the request had the accepts header set to "application/json" or "application/geo+json"
     2) Validate that the content-type header of the response is set to "application/json"
     3) Validate that the response complies with the JSON standard.
 d) References: 
     Requirements: R24, R25
----
----
A.2.9 GML Simple Features Level 0 Extension
 a) Test Purpose: Validate that the GML Simple Features Level 0 extension is supported property
 b) Pre-conditions: Client has determined that the server supports GML SF Level 0
 c) Test Method:
     1) Validate handling of Features and Feature Collections using test A.2.9.1
     2) Validate handling of all other "200" responses using test A.2.9.2 
 d) References: 
     Requirements: R26, R27
     Tests: A.2.9.1, A.2.9.2
----
----
A.2.8.1 GeoJSON Response Validation
 a) Test Purpose: Validate that GeoJSON responses are supported property
 b) Pre-conditions: A Feature or Feature Collection response has been received
 c) Test Method:
     1) Validate that the request had the accepts header set to "application/geo+json"
     2) Validate that the content-type header of the response is set to "application/geo+json"
     3) Validate that the response complies with the GeoJSON standard.
 d) References: 
     Requirements: R24, R25
----
----
A.2.8.2 JSON Response Validation
 a) Test Purpose: Validate that JSON responses are supported property
 b) Pre-conditions: A response has been received which is not a Feature or Feature Collection
 c) Test Method:
     1) Validate that the request had the accepts header set to "application/json" or "application/geo+json"
     2) Validate that the content-type header of the response is set to "application/json"
     3) Validate that the response complies with the JSON standard.
 d) References: 
     Requirements: R24, R25
--------
A.2.8 GML Simple Features Level 2 Extension
 a) Test Purpose:
 b) Pre-conditions:
 c) Test Method:
 d) References: Requirement R8
----

----
A.2.10 OpenAPI 3.0 
 a) Test Purpose:
 b) Pre-conditions:
 c) Test Method:
 d) References: Requirement R10
----

